<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>길드원 정리 & 업로드</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#141a1f; --panel:#1c242b; --panel-2:#202a33; --text:#dfe7ef; --muted:#93a1ad; --accent:#7dd3fc; --ok:#9ae6b4; --radius:14px;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,Helvetica,Arial;}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1180px;margin:34px auto;padding:0 18px}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    header h1{font-size:22px;margin:0}
    .search{margin-left:auto}
    .search input{background:#0f1418;color:var(--text);border:1px solid #2a3640;border-radius:10px;padding:10px 12px;min-width:220px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 22px}
    .btn{background:var(--panel-2);border:1px solid #2b3843;color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px}
    .card{background:var(--panel);border:1px solid #2a3640;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column}
    .cover{aspect-ratio:16/10;background:#0b0f12;display:flex;align-items:center;justify-content:center}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px 14px 14px}
    .title{font-size:16px;font-weight:700;margin:0 0 2px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 10px}
    .row{display:flex;gap:6px;align-items:center}
    input,textarea{background:#0f1418;color:var(--text);border:1px solid #2a3640;border-radius:10px;padding:8px 10px;width:100%}
    label{font-size:12px;color:#9fb1bf}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pill{font-size:11px;padding:2px 8px;border-radius:999px;background:#0f151a;border:1px solid #2a3640;color:#b6c4cf}
    
    /* 우측 하단 관리자 버튼 */
    .admin-float{position:fixed;bottom:20px;right:20px;z-index:100}
    .admin-float .btn{background:var(--accent);color:#000;border:none;padding:12px 16px;border-radius:50px;cursor:pointer;font-size:14px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:all 0.3s}
    .admin-float .btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.4)}
    
    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .wrap{padding:0 12px;margin:20px auto}
      header{flex-direction:column;gap:12px;align-items:stretch}
      header h1{font-size:20px;text-align:center}
      .search{margin-left:0;margin-top:8px}
      .search input{min-width:100%;width:100%}
      .toolbar{justify-content:center;margin:12px 0 18px}
      .grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
      .row2{grid-template-columns:1fr;gap:8px}
      .card .meta{padding:10px 12px 12px}
      .row{flex-direction:column;gap:6px;align-items:stretch}
      .row input[type="file"]{margin-bottom:4px}
      .btn{width:100%;margin:2px 0}
      .admin-float{bottom:15px;right:15px}
      .admin-float .btn{padding:10px 14px;font-size:13px}
    }
    
    @media (max-width: 480px) {
      .wrap{padding:0 8px;margin:16px auto}
      header h1{font-size:18px}
      .grid{grid-template-columns:1fr;gap:10px}
      .card .meta{padding:8px 10px 10px}
      .title{font-size:15px}
      .sub{font-size:12px}
      .row{flex-direction:column;gap:4px;align-items:stretch}
      .btn{padding:8px 10px;font-size:13px}
      .pill{font-size:10px;padding:1px 6px}
      input,textarea{padding:6px 8px;font-size:13px}
      label{font-size:11px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>👥 길드원 정리</h1>
      <nav class="toolbar">
        <a class="btn" href="./index.html">← 사진첩으로</a>
        <button class="btn" id="addMember" style="display:none">길드원 추가</button>
      </nav>
      <div class="search"><input id="q" placeholder="검색: 이름/직책"></div>
    </header>

    <section id="grid" class="grid"></section>
  </div>

  <!-- 우측 하단 관리자 버튼 -->
  <div class="admin-float">
    <a class="btn" href="./admin.html">🔐 관리자</a>
  </div>

  <template id="cardTmpl">
    <article class="card">
      <div class="cover"><span style="opacity:.5">커버 없음</span></div>
      <div class="meta">
        <h3 class="title"></h3>
        <p class="sub"></p>

        <div class="row" style="gap:8px;margin-top:6px">
          <input type="file" class="ipt-file" accept="image/*">
          <button class="btn btn-upload">이미지 업로드</button>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="btn btn-setCover" style="display:none">커버로 지정</button>
          <button class="btn btn-remove" style="display:none">길드원 삭제</button>
        </div>
        <div class="row" style="gap:6px;margin-top:10px;flex-wrap:wrap">
          <a class="pill link" target="_blank" style="display:none">원본</a>
        </div>
      </div>
    </article>
  </template>

  <script>
    const IMGBB_KEY = "ee1e38cf23a8ac3daf5a2dca469763ab";

    // 저장 키
    const memberKey = "guild.members.v1";
    const albumKey  = "album.items.v1"; // index.html과 공유

    // 초기 길드원 샘플 (없으면 자동 생성)
    const DEFAULT_MEMBERS = [
      { id: crypto.randomUUID(), name:"라이티", role:"길드마스터", cover:"" },
      { id: crypto.randomUUID(), name:"코난이-황선", role:"길드원", cover:"" },
      { id: crypto.randomUUID(), name:"현지", role:"길드원", cover:"" },
      { id: crypto.randomUUID(), name:"천사소년네티", role:"길드원", cover:"" },
      { id: crypto.randomUUID(), name:"얼애엘아라", role:"길드원", cover:"" },
      { id: crypto.randomUUID(), name:"수학책", role:"길드원", cover:"" },
    ];

    const grid = document.getElementById('grid');
    const cardTmpl = document.getElementById('cardTmpl');
    const q = document.getElementById('q');
    const addMember = document.getElementById('addMember');
    
    // 관리자 권한 확인
    const ADMIN_KEY = "admin.authenticated";
    const isAdmin = localStorage.getItem(ADMIN_KEY) === 'true';

    function loadMembers(){
      try{
        const raw = localStorage.getItem(memberKey);
        if(!raw){ localStorage.setItem(memberKey, JSON.stringify(DEFAULT_MEMBERS)); return DEFAULT_MEMBERS; }
        return JSON.parse(raw || "[]");
      }catch(e){ return []; }
    }
    function saveMembers(list){ localStorage.setItem(memberKey, JSON.stringify(list)); }
    function loadAlbum(){ try{ return JSON.parse(localStorage.getItem(albumKey)||"[]"); }catch(e){return [];} }
    function saveAlbum(arr){ localStorage.setItem(albumKey, JSON.stringify(arr)); }
    function fmtDate(ts){ const d=new Date(ts); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())}`; }
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

    function render(filter=""){
      const members = loadMembers();
      const term = filter.trim().toLowerCase();
      const filtered = term ? members.filter(m=>{
        return [m.name,m.role].join(" ").toLowerCase().includes(term);
      }) : members;

      grid.innerHTML = "";
      for(const m of filtered){
        const node = cardTmpl.content.cloneNode(true);
        const card = node.querySelector('.card');
        const cover = node.querySelector('.cover');
        const ttl = node.querySelector('.title');
        const sub = node.querySelector('.sub');
        const btnUpload = node.querySelector('.btn-upload');
        const iptFile = node.querySelector('.ipt-file');
        const link = node.querySelector('.link');
        const btnSetCover = node.querySelector('.btn-setCover');
        const btnRemove = node.querySelector('.btn-remove');

        ttl.textContent = m.name;
        sub.textContent = m.role || "길드원";
        if(m.cover){ cover.innerHTML = `<img src="${m.cover}" alt="">`; }

        // 관리자 권한에 따른 UI 표시
        if (isAdmin) {
          btnSetCover.style.display = 'inline-block';
          btnRemove.style.display = 'inline-block';
          btnUpload.style.display = 'inline-block';
          iptFile.style.display = 'block';
        } else {
          btnSetCover.style.display = 'none';
          btnRemove.style.display = 'none';
          btnUpload.style.display = 'none';
          iptFile.style.display = 'none';
        }

        // 업로드 동작
        btnUpload.onclick = async ()=>{
          const f = iptFile.files?.[0];
          if(!f){ alert("이미지 파일을 선택하세요."); return; }
          btnUpload.disabled = true; btnUpload.textContent = "업로드 중…";
          try{
            const fd = new FormData(); fd.append("image", f);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {method:"POST",body:fd});
            if(!res.ok) throw new Error("ImgBB 업로드 실패");
            const data = await res.json();
            const url = data?.data?.url || data?.data?.display_url;
            if(!url) throw new Error("응답 파싱 실패");

            // 사진첩에도 동일 아이템으로 추가 (기본값으로 설정)
            const item = {
              id: crypto.randomUUID(),
              url,
              title: `${m.name} 업로드`,
              subtitle: "길드원 업로드",
              author: m.name,
              tags: ["길드", "업로드"],
              createdAt: Date.now()
            };
            const album = loadAlbum(); album.push(item); saveAlbum(album);

            // 카드의 최근 링크 표기
            link.href = url; link.style.display="inline-block"; link.textContent = "원본";

            alert("업로드 완료! 사진첩에도 반영되었습니다.");
          }catch(err){
            alert(err.message);
          }finally{
            btnUpload.disabled=false; btnUpload.textContent="이미지 업로드";
          }
        };

        // 커버 지정(가장 최근 업로드를 커버로)
        btnSetCover.onclick = ()=>{
          const album = loadAlbum()
            .filter(a => (a.author||"").toLowerCase() === (m.name||"").toLowerCase())
            .sort((a,b)=>b.createdAt-a.createdAt);
          if(!album[0]){ alert("해당 작성자의 업로드를 찾지 못했습니다. 먼저 업로드해주세요."); return; }
          m.cover = album[0].url;
          const list = loadMembers(); const idx = list.findIndex(x=>x.id===m.id);
          if(idx>-1){ list[idx]=m; saveMembers(list); }
          cover.innerHTML = `<img src="${m.cover}" alt="">`;
        };

        // 길드원 삭제
        btnRemove.onclick = ()=>{
          // admin.html의 삭제 모달 사용
          if (window.showDeleteModal) {
            window.showDeleteModal(
              `정말로 '${m.name}' 길드원을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`,
              () => {
                const list = loadMembers().filter(x=>x.id!==m.id);
                saveMembers(list); 
                render(q.value);
              }
            );
          } else {
            // admin.html이 로드되지 않은 경우 기본 confirm 사용
            if(!confirm(`정말 '${m.name}' 카드를 삭제할까요?`)) return;
            const list = loadMembers().filter(x=>x.id!==m.id);
            saveMembers(list); 
            render(q.value);
          }
        };

        grid.appendChild(node);
      }
    }

    // 관리자 권한에 따른 UI 표시
    if (isAdmin) {
      addMember.style.display = 'inline-block';
    }

    // 검색
    q.addEventListener('input', ()=>render(q.value));

    // 길드원 추가 (관리자만)
    addMember.onclick = ()=>{
      if (!isAdmin) return;
      const name = prompt("길드원 이름"); if(!name) return;
      const role = prompt("직책/상태(예: 길드원, 밤샘, 새벽, 저녁 등)") || "길드원";
      const list = loadMembers();
      list.push({ id: crypto.randomUUID(), name, role, cover:"", createdAt: Date.now() });
      saveMembers(list); render(q.value);
    };


    // 초기 렌더
    if(!localStorage.getItem(memberKey)) saveMembers(DEFAULT_MEMBERS);
    render();
  </script>
</body>
</html>
