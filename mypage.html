<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>마이페이지 - NBTI 길드</title>
  <meta name="color-scheme" content="dark light">
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="./js/data-manager.js"></script>
</head>
<body>
  <!-- 상단 헤더 -->
  <header class="main-header">
    <div class="header-content">
      <a href="./index.html" class="logo">
        <h1>🏰 NBTI 길드</h1>
      </a>
      <nav class="header-nav">
        <a href="./picture.html" class="nav-link" data-page="picture">
          <img src="./img/camera.png" alt="카메라" class="nav-icon">
          사진첩
        </a>
        <a href="./members.html" class="nav-link" data-page="members">👥 길드원</a>
        <a href="#" class="nav-link login-btn" id="loginBtn" title="로그인">
          <i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i>
        </a>
      </nav>
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- 모바일 사이드바 오버레이 -->
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

  <!-- 모바일 사이드바 -->
  <div class="mobile-sidebar" id="mobileSidebar">
    <div class="sidebar-header">
      <a href="./index.html" class="sidebar-logo">
        <h2>🏰 NBTI 길드</h2>
      </a>
      <button class="sidebar-close" id="sidebarClose">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="./picture.html" class="sidebar-link" data-page="picture">
        <img src="./img/camera.png" alt="카메라" class="sidebar-icon">
        사진첩
      </a>
      <a href="./members.html" class="sidebar-link" data-page="members">👥 길드원</a>
      <a href="#" class="sidebar-link login-btn" id="mobileLoginBtn" title="로그인">
        <i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i> 로그인
      </a>
    </nav>
  </div>

  <!-- 히어로 섹션 -->
  <section class="hero-section">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <p class="hero-subtitle">마비노기 모바일 던컨 서버</p>
      <h1 class="hero-title">마이페이지</h1>
    </div>
  </section>

  <div class="wrap">
    <!-- 로그인 섹션 -->
    <div id="loginSection" class="login-section">
      <div class="login-card">
        <h2>길드원 로그인</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="loginId">아이디</label>
            <input type="text" id="loginId" placeholder="아이디를 입력하세요" required>
          </div>
          <div class="form-group">
            <label for="password">비밀번호</label>
            <input type="password" id="password" placeholder="비밀번호를 입력하세요" required>
          </div>
          <button type="submit" class="btn btn-primary">로그인</button>
        </form>
        <div class="login-help">
          <p>💡 테스트 계정:</p>
          <ul>
            <li>작은음표: smallnote / guildmaster123</li>
            <li>아쉬운데잉: ashy / ashy123</li>
            <li>돌하나: dol / dol123</li>
            <li>전사도로롱: doro / doro123</li>
            <li>이시후: sihu / sihu123</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- 마이페이지 섹션 -->
    <div id="mypageSection" class="mypage-section" style="display: none;">
      <div class="page-header">
        <div class="page-title-row">
          <h1>👤 마이페이지</h1>
          <button class="btn btn-secondary" id="logoutBtn">로그아웃</button>
        </div>
      </div>

      <div class="mypage-content">
        <!-- 프로필 카드 -->
        <div class="profile-card">
          <div class="profile-header">
            <div class="profile-cover" id="profileCover">
              <div class="cover-upload-overlay">
                <input type="file" id="coverFile" accept="image/*" style="display: none;">
                <button type="button" class="cover-upload-icon" id="uploadCoverBtn" title="커버 이미지 업로드">
                  <i class="fa-solid fa-camera"></i>
                </button>
              </div>
            </div>
            <div class="profile-info">
              <h2 id="profileName"></h2>
              <p id="profileRole"></p>
              <p id="profileEmail"></p>
            </div>
          </div>
        </div>

        <!-- 편집 폼 -->
        <div class="edit-form-card">
          <h3>프로필 편집</h3>
          <form id="profileForm">
            <div class="form-row">
              <div class="form-group">
                <label for="editName">이름</label>
                <input type="text" id="editName" required>
              </div>
              <div class="form-group">
                <label for="editRole">직책</label>
                <input type="text" id="editRole" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="editBio">자기소개</label>
              <textarea id="editBio" rows="3" placeholder="자기소개를 입력하세요"></textarea>
            </div>


            <div class="form-group">
              <label for="editInterests">관심사 (쉼표로 구분)</label>
              <input type="text" id="editInterests" placeholder="예: 던전, 레이드, 친목">
            </div>

            <div class="form-group">
              <label for="editTags">태그 (쉼표로 구분)</label>
              <input type="text" id="editTags" placeholder="예: 길드원, 레이드, 친목">
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" id="cancelEdit">취소</button>
              <button type="submit" class="btn btn-primary">저장</button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <script>
    const IMGBB_KEY = "ee1e38cf23a8ac3daf5a2dca469763ab";
    
    // DOM 요소들
    const loginSection = document.getElementById('loginSection');
    const mypageSection = document.getElementById('mypageSection');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileForm = document.getElementById('profileForm');
    const cancelEditBtn = document.getElementById('cancelEdit');
    const uploadCoverBtn = document.getElementById('uploadCoverBtn');
    const coverFile = document.getElementById('coverFile');
    
    // 프로필 표시 요소들
    const profileName = document.getElementById('profileName');
    const profileRole = document.getElementById('profileRole');
    const profileEmail = document.getElementById('profileEmail');
    const profileCover = document.getElementById('profileCover');
    
    // 편집 폼 요소들
    const editName = document.getElementById('editName');
    const editRole = document.getElementById('editRole');
    const editBio = document.getElementById('editBio');
    const editInterests = document.getElementById('editInterests');
    const editTags = document.getElementById('editTags');
    
    let currentUser = null;

    // 로그인 처리
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const loginId = document.getElementById('loginId').value;
      const password = document.getElementById('password').value;
      
      try {
        // 캐시를 강제로 새로고침하여 최신 데이터 보장
        dataManager.clearCache();
        const members = await dataManager.loadMembers();
        const user = members.find(member => 
          member.loginId === loginId && member.password === password
        );
        
        if (user) {
          currentUser = user;
          // 로그인 시간 업데이트
          await dataManager.updateMember(user.id, { lastLogin: Date.now() });
          
          // 세션 저장
          localStorage.setItem('user.authenticated', 'true');
          localStorage.setItem('user.id', user.id);
          
          showMypage();
        } else {
          alert('아이디 또는 비밀번호가 올바르지 않습니다.');
        }
      } catch (error) {
        console.error('로그인 오류:', error);
        alert('로그인 중 오류가 발생했습니다.');
      }
    });

    // 로그아웃 처리
    logoutBtn.addEventListener('click', () => {
      currentUser = null;
      localStorage.removeItem('user.authenticated');
      localStorage.removeItem('user.id');
      showLogin();
    });

    // 프로필 폼 제출
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUser) return;
      
      try {
        const interests = editInterests.value.split(',').map(s => s.trim()).filter(Boolean);
        const tags = editTags.value.split(',').map(s => s.trim()).filter(Boolean);
        
        const updateData = {
          name: editName.value,
          role: editRole.value,
          tags: tags,
          profile: {
            bio: editBio.value,
            interests: interests
          }
        };
        
        await dataManager.updateMember(currentUser.id, updateData);
        
        // 현재 사용자 정보 업데이트
        currentUser = { ...currentUser, ...updateData };
        
        updateProfileDisplay();
        alert('프로필이 성공적으로 업데이트되었습니다!');
      } catch (error) {
        console.error('프로필 업데이트 오류:', error);
        alert('프로필 업데이트 중 오류가 발생했습니다.');
      }
    });

    // 취소 버튼
    cancelEditBtn.addEventListener('click', () => {
      loadProfileToForm();
    });

    // 커버 이미지 업로드
    uploadCoverBtn.addEventListener('click', () => {
      coverFile.click();
    });

    coverFile.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      
      uploadCoverBtn.disabled = true;
      
      try {
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) throw new Error('ImgBB 업로드 실패');
        
        const data = await response.json();
        const url = data?.data?.url || data?.data?.display_url;
        
        if (!url) throw new Error('응답 파싱 실패');
        
        // 커버 이미지 업데이트
        await dataManager.updateMember(currentUser.id, { cover: url });
        currentUser.cover = url;
        
        updateProfileDisplay();
        alert('커버 이미지가 업로드되었습니다!\n\n다른 페이지에서도 업데이트된 커버 이미지를 확인할 수 있습니다.');
        
      } catch (error) {
        console.error('커버 업로드 오류:', error);
        alert('커버 이미지 업로드 중 오류가 발생했습니다.');
      } finally {
        uploadCoverBtn.disabled = false;
        coverFile.value = '';
      }
    });

    // 로그인 화면 표시
    function showLogin() {
      loginSection.style.display = 'block';
      mypageSection.style.display = 'none';
    }

    // 마이페이지 표시
    function showMypage() {
      loginSection.style.display = 'none';
      mypageSection.style.display = 'block';
      loadProfileToForm();
      updateProfileDisplay();
    }

    // 프로필 정보를 폼에 로드
    function loadProfileToForm() {
      if (!currentUser) return;
      
      editName.value = currentUser.name || '';
      editRole.value = currentUser.role || '';
      editBio.value = currentUser.profile?.bio || '';
      editInterests.value = (currentUser.profile?.interests || []).join(', ');
      editTags.value = (currentUser.tags || []).join(', ');
    }

    // 프로필 표시 업데이트
    function updateProfileDisplay() {
      if (!currentUser) return;
      
      profileName.textContent = currentUser.name || '';
      profileRole.textContent = currentUser.role || '';
      profileEmail.textContent = currentUser.email || '';
      
      // 커버 이미지 설정
      const coverStyle = currentUser.cover ? 
        `background-image: url('${currentUser.cover}')` : 
        `background-image: url('img/cover.webp')`;
      profileCover.style.cssText = coverStyle;
    }

    // 페이지 초기화
    async function initializePage() {
      // 세션 확인
      const isAuthenticated = localStorage.getItem('user.authenticated') === 'true';
      const userId = localStorage.getItem('user.id');
      
      if (isAuthenticated && userId) {
        try {
          // 캐시를 강제로 새로고침하여 최신 데이터 보장
          dataManager.clearCache();
          const members = await dataManager.loadMembers();
          const user = members.find(member => member.id === userId);
          
          if (user) {
            currentUser = user;
            showMypage();
            return;
          }
        } catch (error) {
          console.error('사용자 정보 로드 오류:', error);
        }
      }
      
      showLogin();
    }

    // 헤더 이벤트 초기화 함수
    function initHeaderEvents() {
      // 현재 페이지 감지 및 활성 상태 설정
      const currentPage = getCurrentPage();
      setActiveNav(currentPage);
      
      // 모바일 메뉴 기능
      initMobileMenu();
    }

    // 현재 페이지 감지
    function getCurrentPage() {
      const path = window.location.pathname;
      if (path.includes('index.html') || path === '/' || path.endsWith('/')) return 'index';
      if (path.includes('picture.html')) return 'picture';
      if (path.includes('members.html')) return 'members';
      if (path.includes('mypage.html')) return 'mypage';
      if (path.includes('admin.html')) return 'admin';
      return 'index';
    }

    // 활성 네비게이션 설정
    function setActiveNav(currentPage) {
      // 데스크톱 네비게이션
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });
      
      // 모바일 사이드바 네비게이션
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });
    }

    // 모바일 메뉴 기능
    function initMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileSidebar = document.getElementById('mobileSidebar');
      const mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarLinks = document.querySelectorAll('.sidebar-link');

      if (!mobileMenuBtn || !mobileSidebar || !mobileSidebarOverlay) return;

      // 사이드바 열기
      function openSidebar() {
        mobileSidebar.classList.add('active');
        mobileSidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      // 사이드바 닫기
      function closeSidebar() {
        mobileSidebar.classList.remove('active');
        mobileSidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      // 햄버거 메뉴 클릭
      mobileMenuBtn.addEventListener('click', openSidebar);

      // 사이드바 닫기 버튼 클릭
      sidebarClose.addEventListener('click', closeSidebar);

      // 사이드바 링크 클릭 시 닫기
      sidebarLinks.forEach(link => {
        link.addEventListener('click', closeSidebar);
      });

      // 오버레이 클릭 시 닫기
      mobileSidebarOverlay.addEventListener('click', closeSidebar);
    }

    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', () => {
      initHeaderEvents();
      initializePage();
    });
  </script>
</body>
</html>
