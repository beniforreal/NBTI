<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‚¬ì§„ì²©</title>
  <meta name="color-scheme" content="dark light">
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="./js/data-manager.js"></script>
</head>
<body>
  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="main-header">
    <div class="header-content">
      <a href="./index.html" class="logo">
        <h1>ğŸ° NBTI ê¸¸ë“œ</h1>
      </a>
      <nav class="header-nav">
        <a href="./picture.html" class="nav-link" data-page="picture">
          <img src="./img/camera.png" alt="ì¹´ë©”ë¼" class="nav-icon">
          ì‚¬ì§„ì²©
        </a>
        <a href="./members.html" class="nav-link" data-page="members">ğŸ‘¥ ê¸¸ë“œì›</a>
        <a href="#" class="nav-link login-btn" id="loginBtn" title="ë¡œê·¸ì¸">
          <i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i>
        </a>
      </nav>
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

  <!-- ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” -->
  <div class="mobile-sidebar" id="mobileSidebar">
    <div class="sidebar-header">
      <a href="./index.html" class="sidebar-logo">
        <h2>ğŸ° NBTI ê¸¸ë“œ</h2>
      </a>
      <button class="sidebar-close" id="sidebarClose">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="./picture.html" class="sidebar-link" data-page="picture">
        <img src="./img/camera.png" alt="ì¹´ë©”ë¼" class="sidebar-icon">
        ì‚¬ì§„ì²©
      </a>
      <a href="./members.html" class="sidebar-link" data-page="members">ğŸ‘¥ ê¸¸ë“œì›</a>
      <a href="#" class="sidebar-link login-btn" id="mobileLoginBtn" title="ë¡œê·¸ì¸">
        <i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i> ë¡œê·¸ì¸
      </a>
    </nav>
  </div>

  <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
  <section class="hero-section">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <p class="hero-subtitle">ë§ˆë¹„ë…¸ê¸° ëª¨ë°”ì¼ ë˜ì»¨ ì„œë²„</p>
      <h1 class="hero-title">NBTI ê¸¸ë“œ</h1>
    </div>
  </section>

  <div class="wrap">
    <div class="page-header">
      <div class="page-title-row">
        <h1>
          <img src="./img/camera.png" alt="ì¹´ë©”ë¼" class="page-icon">
          ì‚¬ì§„ì²©
        </h1>
        <button class="search-toggle-btn" id="searchToggle" title="ê²€ìƒ‰">
          ğŸ”
        </button>
      </div>
      <nav class="toolbar">
        <button class="btn" id="openAdd" style="display:none">ì‚¬ì§„ ì—…ë¡œë“œ</button>
      </nav>
      <div class="search search-collapsed" id="searchContainer">
        <input id="q" placeholder="ê²€ìƒ‰: ì œëª©/ë¶€ì œ/ì‘ì„±ì/íƒœê·¸">
      </div>
    </div>

    <section id="grid" class="grid"></section>
    <div id="empty" class="empty" hidden>ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ <b>ì‚¬ì§„ ì—…ë¡œë“œ</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</div>

    <footer>ë¡œì»¬ ì €ì¥ì†Œ(localStorage)ì— ë©”íƒ€ë°ì´í„°ê°€ ì €ì¥ë©ë‹ˆë‹¤. ì´ë¯¸ì§€ëŠ” ImgBBì— ì—…ë¡œë“œë©ë‹ˆë‹¤.</footer>
  </div>


  <!-- ì—…ë¡œë“œ ë‹¤ì´ì–¼ë¡œê·¸ -->
  <dialog id="dlg">
    <div class="dlg-h">ì‚¬ì§„ ì—…ë¡œë“œ</div>
    <form method="dialog" id="form">
      <div class="dlg-b">
        <div>
          <label>ì´ë¯¸ì§€ íŒŒì¼</label>
          <input type="file" id="file" accept="image/*" required>
        </div>
        <div class="row2">
          <div><label>ì œëª©</label><input id="title" placeholder="ì˜ˆ) í•œì—¬ë¦„ ë°¤ì˜ ê¿ˆ" required></div>
          <div><label>ë¶€ì œ/ì¥ì†Œ</label><input id="subtitle" placeholder="ì˜ˆ) í´ëœ / ì„œìš¸"></div>
        </div>
        <div class="row2">
          <div><label>ì‘ì„±ì</label><input id="author" placeholder="ì˜ˆ) ë¼ì´í‹°"></div>
          <div><label>íƒœê·¸(ì‰¼í‘œë¡œ êµ¬ë¶„)</label><input id="tags" placeholder="ì˜ˆ) ê¸¸ë“œ,ëª¨ì„,ì´ë²¤íŠ¸"></div>
        </div>
      </div>
      <div class="dlg-f">
        <button class="btn" type="button" id="cancelBtn">ì·¨ì†Œ</button>
        <button class="btn" id="submitBtn" value="default">ì—…ë¡œë“œ</button>
      </div>
    </form>
  </dialog>

  <!-- ìƒì„¸ í˜ì´ì§€ ëª¨ë‹¬ -->
  <div id="detailModal" class="detail-modal">
    <div class="detail-content">
      <div class="detail-header">
        <h2 id="detailTitle" class="detail-title"></h2>
        <button id="detailClose" class="detail-close">&times;</button>
      </div>
      <div class="detail-body">
        <img id="detailImage" class="detail-image" src="" alt="">
        <div class="detail-meta">
          <div class="detail-row">
            <span class="detail-label">ë¶€ì œ/ì¥ì†Œ</span>
            <span id="detailSubtitle" class="detail-value"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì‘ì„±ì</span>
            <span id="detailAuthor" class="detail-value"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ì—…ë¡œë“œì¼</span>
            <span id="detailDate" class="detail-value"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">íƒœê·¸</span>
            <div id="detailTags" class="detail-tags"></div>
          </div>
        </div>
        <div class="detail-actions">
          <a id="detailViewOriginal" class="btn" href="" target="_blank">ì›ë³¸ ë³´ê¸°</a>
          <button id="detailDelete" class="btn danger" style="display:none">ì‚­ì œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="login-modal">
    <div class="login-modal-content">
      <div class="login-modal-header">
        <h2>ê¸¸ë“œì› ë¡œê·¸ì¸</h2>
        <button class="login-modal-close" id="loginModalClose">&times;</button>
      </div>
      <div class="login-modal-body">
        <form id="loginForm">
          <div class="form-group">
            <label for="loginId">ì•„ì´ë””</label>
            <input type="text" id="loginId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
          </div>
          <div class="form-group">
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
          </div>
          <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
        </form>
        <div class="login-help">
          <p>ğŸ’¡ í…ŒìŠ¤íŠ¸ ê³„ì •:</p>
          <ul>
            <li>ì‘ì€ìŒí‘œ: smallnote / guildmaster123</li>
            <li>ì•„ì‰¬ìš´ë°ì‰: ashy / ashy123</li>
            <li>ëŒí•˜ë‚˜: dol / dol123</li>
            <li>ì „ì‚¬ë„ë¡œë¡±: doro / doro123</li>
            <li>ì´ì‹œí›„: sihu / sihu123</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const IMGBB_KEY = "ee1e38cf23a8ac3daf5a2dca469763ab";

    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const q = document.getElementById('q');
    const dlg = document.getElementById('dlg');
    const openAdd = document.getElementById('openAdd');
    const form = document.getElementById('form');
    const file = document.getElementById('file');
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const authorEl = document.getElementById('author');
    const tagsEl = document.getElementById('tags');
    const submitBtn = document.getElementById('submitBtn');
    
    // ìƒì„¸ ëª¨ë‹¬ ìš”ì†Œë“¤
    const detailModal = document.getElementById('detailModal');
    const detailTitle = document.getElementById('detailTitle');
    const detailImage = document.getElementById('detailImage');
    const detailSubtitle = document.getElementById('detailSubtitle');
    const detailAuthor = document.getElementById('detailAuthor');
    const detailDate = document.getElementById('detailDate');
    const detailTags = document.getElementById('detailTags');
    const detailViewOriginal = document.getElementById('detailViewOriginal');
    const detailDelete = document.getElementById('detailDelete');
    const detailClose = document.getElementById('detailClose');
    const cancelBtn = document.getElementById('cancelBtn');
    
    // ê²€ìƒ‰ í† ê¸€ ê´€ë ¨ ìš”ì†Œë“¤
    const searchToggle = document.getElementById('searchToggle');
    const searchContainer = document.getElementById('searchContainer');
    
    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const ADMIN_KEY = "admin.authenticated";
    const isAdmin = localStorage.getItem(ADMIN_KEY) === 'true';

    async function loadPhotos(){
      try{ 
        // ìºì‹œë¥¼ ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ë°ì´í„° ë³´ì¥
        dataManager.clearCache();
        return await dataManager.loadPhotos(); 
      }
      catch(e){ 
        console.error('ì‚¬ì§„ ë¡œë“œ ì‹¤íŒ¨:', e);
        return []; 
      }
    }
    
    function fmtDate(ts){
      return utils.formatDate(ts);
    }
    async function render(filter=""){
      const items = await loadPhotos();
      const term = filter.trim().toLowerCase();
      const filtered = term ? items.filter(it=>{
        const hay = [it.title,it.subtitle,it.author,(it.tags||[]).join(",")].join(" ").toLowerCase();
        return hay.includes(term);
      }) : items;

      grid.innerHTML = "";
      if(filtered.length===0){ empty.hidden=false; return; }
      empty.hidden=true;

      for(const it of filtered.sort((a,b)=>(b.updatedAt || b.createdAt)-(a.updatedAt || a.createdAt))){
        const card = document.createElement('article'); card.className="card";
        card.innerHTML = `
          <div class="thumb" style="cursor:pointer" data-id="${it.id}">${it.url ? `<img src="${it.url}" alt="">`:""}</div>
          <div class="meta">
            <h3 class="title" style="cursor:pointer" data-id="${it.id}">${utils.escapeHtml(it.title)}</h3>
            <p class="sub">${utils.escapeHtml(it.subtitle||"")}</p>
            <div class="row">
              <span>${utils.escapeHtml(it.author||"")}</span>
              <span>${fmtDate(it.updatedAt || it.createdAt)}</span>
            </div>
            <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
              ${(it.tags||[]).slice(0,6).map(t=>`<span class="pill">${utils.escapeHtml(t)}</span>`).join("")}
            </div>
            <div style="margin-top:10px;display:flex;gap:6px">
              <a class="btn" href="${it.url}" target="_blank">ì›ë³¸ ë³´ê¸°</a>
              ${isAdmin ? `<button class="btn danger" data-id="${it.id}">ì‚­ì œ</button>` : ''}
            </div>
          </div>`;
        grid.appendChild(card);
      }

      // ìƒì„¸ ë³´ê¸° í•¸ë“¤ëŸ¬ (ì´ë¯¸ì§€ì™€ ì œëª© í´ë¦­)
      grid.querySelectorAll('.thumb, .title').forEach(element=>{
        element.onclick = () => {
          const id = element.getAttribute('data-id');
          showDetail(id);
        };
      });

      // ì‚­ì œ í•¸ë“¤ëŸ¬
      grid.querySelectorAll('.danger').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          const items = await loadPhotos();
          const item = items.find(it => it.id === id);
          if (!item) return;
          
          // admin.htmlì˜ ì‚­ì œ ëª¨ë‹¬ ì‚¬ìš©
          if (window.showDeleteModal) {
            window.showDeleteModal(
              `ì •ë§ë¡œ '${item.title}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
              async () => {
                const success = await dataManager.deletePhoto(id);
                if (success) {
                  await render(q.value);
                } else {
                  alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
              }
            );
          } else {
            // admin.htmlì´ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ confirm ì‚¬ìš©
            if (confirm(`ì •ë§ë¡œ '${item.title}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              const success = await dataManager.deletePhoto(id);
              if (success) {
                await render(q.value);
              } else {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              }
            }
          }
        };
      });
    }
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

    // ìƒì„¸ í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜
    async function showDetail(id) {
      const items = await loadPhotos();
      const item = items.find(it => it.id === id);
      if (!item) return;

      detailTitle.textContent = item.title;
      detailImage.src = item.url;
      detailImage.alt = item.title;
      detailSubtitle.textContent = item.subtitle || "ì •ë³´ ì—†ìŒ";
      detailAuthor.textContent = item.author || "ì •ë³´ ì—†ìŒ";
      detailDate.textContent = fmtDate(item.updatedAt || item.createdAt);
      detailViewOriginal.href = item.url;
      
      // íƒœê·¸ í‘œì‹œ
      detailTags.innerHTML = "";
      if (item.tags && item.tags.length > 0) {
        item.tags.forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'pill';
          tagEl.textContent = tag;
          detailTags.appendChild(tagEl);
        });
      } else {
        detailTags.innerHTML = '<span style="color: var(--muted); font-style: italic;">íƒœê·¸ ì—†ìŒ</span>';
      }

      // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ (ê´€ë¦¬ìë§Œ)
      if (isAdmin) {
        detailDelete.style.display = 'inline-block';
        detailDelete.onclick = async () => {
          // admin.htmlì˜ ì‚­ì œ ëª¨ë‹¬ ì‚¬ìš©
          if (window.showDeleteModal) {
            window.showDeleteModal(
              `ì •ë§ë¡œ '${item.title}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
              async () => {
                const success = await dataManager.deletePhoto(id);
                if (success) {
                  await render(q.value);
                  detailModal.style.display = 'none';
                } else {
                  alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
              }
            );
          } else {
            // admin.htmlì´ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ confirm ì‚¬ìš©
            if (confirm(`ì •ë§ '${item.title}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              const success = await dataManager.deletePhoto(id);
              if (success) {
                await render(q.value);
                detailModal.style.display = 'none';
              } else {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              }
            }
          }
        };
      }

      detailModal.style.display = 'flex';
    }

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
    detailClose.onclick = () => detailModal.style.display = 'none';
    detailModal.onclick = (e) => {
      if (e.target === detailModal) detailModal.style.display = 'none';
    };

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && detailModal.style.display === 'flex') {
        detailModal.style.display = 'none';
      }
    });

    // ê²€ìƒ‰ í† ê¸€ ê¸°ëŠ¥
    function toggleSearch() {
      searchContainer.classList.toggle('search-collapsed');
      if (searchContainer.classList.contains('search-collapsed')) {
        searchToggle.textContent = 'ğŸ”';
        searchToggle.title = 'ê²€ìƒ‰';
        searchToggle.classList.remove('close-btn');
        q.value = '';
        render('');
      } else {
        searchToggle.textContent = '';
        searchToggle.title = 'ê²€ìƒ‰ ë‹«ê¸°';
        searchToggle.classList.add('close-btn');
        q.focus();
      }
    }

    // ê²€ìƒ‰ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
    searchToggle.addEventListener('click', toggleSearch);

    // ê´€ë¦¬ì ê¶Œí•œì— ë”°ë¥¸ UI í‘œì‹œ
    if (isAdmin) {
      openAdd.style.display = 'inline-block';
    }

    q.addEventListener('input', ()=>render(q.value));
    openAdd.addEventListener('click', ()=>{ form.reset(); dlg.showModal(); });

    // ì—…ë¡œë“œ ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
    dlg.addEventListener('click', (e) => {
      if (e.target === dlg) {
        dlg.close();
      }
    });

    // ESC í‚¤ë¡œ ì—…ë¡œë“œ ëª¨ë‹¬ ë‹«ê¸°
    dlg.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        dlg.close();
      }
    });

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    cancelBtn.addEventListener('click', () => {
      dlg.close();
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = file.files?.[0];
      if(!f){ alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
      submitBtn.disabled = true; submitBtn.textContent = "ì—…ë¡œë“œ ì¤‘â€¦";

      try{
        const fd = new FormData(); fd.append("image", f);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method:"POST", body:fd });
        if(!res.ok) throw new Error("ImgBB ì—…ë¡œë“œ ì‹¤íŒ¨");
        const data = await res.json();
        const url = data?.data?.url || data?.data?.display_url;
        if(!url) throw new Error("ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨");

        const photoData = {
          url,
          title: titleEl.value.trim(),
          subtitle: subtitleEl.value.trim(),
          author: authorEl.value.trim(),
          tags: (tagsEl.value||"").split(",").map(s=>s.trim()).filter(Boolean)
        };
        
        await dataManager.addPhoto(photoData);
        dlg.close(); 
        await render(q.value);
      }catch(err){
        alert(err.message);
      }finally{
        submitBtn.disabled=false; submitBtn.textContent="ì—…ë¡œë“œ";
      }
    });


    // ë¡œê·¸ì¸ ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
    let currentUser = null;
    const loginModal = document.getElementById('loginModal');
    const loginBtn = document.getElementById('loginBtn');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const loginModalClose = document.getElementById('loginModalClose');
    const loginForm = document.getElementById('loginForm');

    // ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸°
    function openLoginModal() {
      loginModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
    function closeLoginModal() {
      loginModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const loginId = document.getElementById('loginId').value;
      const password = document.getElementById('password').value;
      
      try {
        // ìºì‹œë¥¼ ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ë°ì´í„° ë³´ì¥
        dataManager.clearCache();
        const members = await dataManager.loadMembers();
        const user = members.find(member => 
          member.loginId === loginId && member.password === password
        );
        
        if (user) {
          currentUser = user;
          // ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
          await dataManager.updateMember(user.id, { lastLogin: Date.now() });
          
          // ì„¸ì…˜ ì €ì¥
          localStorage.setItem('user.authenticated', 'true');
          localStorage.setItem('user.id', user.id);
          
          // ë¡œê·¸ì¸ ë²„íŠ¼ì„ ë§ˆì´í˜ì´ì§€ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
          updateLoginButton();
          closeLoginModal();
          
          alert(`${user.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
        } else {
          alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ë¡œê·¸ì¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    function updateLoginButton() {
      if (currentUser) {
        loginBtn.innerHTML = `<i class="fa-solid fa-user" style="color: #4CAF50;"></i>`;
        loginBtn.title = `${currentUser.name}ë‹˜ (í´ë¦­í•˜ì—¬ ë§ˆì´í˜ì´ì§€)`;
        loginBtn.href = './mypage.html';
        
        mobileLoginBtn.innerHTML = `<i class="fa-solid fa-user" style="color: #4CAF50;"></i> ${currentUser.name}`;
        mobileLoginBtn.title = 'ë§ˆì´í˜ì´ì§€';
        mobileLoginBtn.href = './mypage.html';
      } else {
        loginBtn.innerHTML = `<i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i>`;
        loginBtn.title = 'ë¡œê·¸ì¸';
        loginBtn.href = '#';
        
        mobileLoginBtn.innerHTML = `<i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i> ë¡œê·¸ì¸`;
        mobileLoginBtn.title = 'ë¡œê·¸ì¸';
        mobileLoginBtn.href = '#';
      }
    }

    // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    loginBtn.addEventListener('click', (e) => {
      if (!currentUser) {
        e.preventDefault();
        openLoginModal();
      }
    });

    mobileLoginBtn.addEventListener('click', (e) => {
      if (!currentUser) {
        e.preventDefault();
        openLoginModal();
      }
    });

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
    loginModalClose.addEventListener('click', closeLoginModal);
    loginModal.addEventListener('click', (e) => {
      if (e.target === loginModal) {
        closeLoginModal();
      }
    });

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && loginModal.style.display === 'flex') {
        closeLoginModal();
      }
    });

    // ì„¸ì…˜ í™•ì¸ ë° ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
    function checkLoginStatus() {
      const isAuthenticated = localStorage.getItem('user.authenticated') === 'true';
      const userId = localStorage.getItem('user.id');
      
      if (isAuthenticated && userId) {
        // ìºì‹œë¥¼ ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ë°ì´í„° ë³´ì¥
        dataManager.clearCache();
        dataManager.loadMembers().then(members => {
          const user = members.find(member => member.id === userId);
          if (user) {
            currentUser = user;
            updateLoginButton();
          }
        }).catch(error => {
          console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
      }
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    async function initializePage() {
      try {
        await render();
        checkLoginStatus();
        console.log('ì‚¬ì§„ì²© í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
      }
    }

    // í—¤ë” ì´ë²¤íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
    function initHeaderEvents() {
      // í˜„ì¬ í˜ì´ì§€ ê°ì§€ ë° í™œì„± ìƒíƒœ ì„¤ì •
      const currentPage = getCurrentPage();
      setActiveNav(currentPage);
      
      // ëª¨ë°”ì¼ ë©”ë‰´ ê¸°ëŠ¥
      initMobileMenu();
    }

    // í˜„ì¬ í˜ì´ì§€ ê°ì§€
    function getCurrentPage() {
      const path = window.location.pathname;
      if (path.includes('index.html') || path === '/' || path.endsWith('/')) return 'index';
      if (path.includes('picture.html')) return 'picture';
      if (path.includes('members.html')) return 'members';
      if (path.includes('mypage.html')) return 'mypage';
      if (path.includes('admin.html')) return 'admin';
      return 'index';
    }

    // í™œì„± ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
    function setActiveNav(currentPage) {
      // ë°ìŠ¤í¬í†± ë„¤ë¹„ê²Œì´ì…˜
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });
      
      // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });
    }

    // ëª¨ë°”ì¼ ë©”ë‰´ ê¸°ëŠ¥
    function initMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileSidebar = document.getElementById('mobileSidebar');
      const mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarLinks = document.querySelectorAll('.sidebar-link');

      if (!mobileMenuBtn || !mobileSidebar || !mobileSidebarOverlay) return;

      // ì‚¬ì´ë“œë°” ì—´ê¸°
      function openSidebar() {
        mobileSidebar.classList.add('active');
        mobileSidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      // ì‚¬ì´ë“œë°” ë‹«ê¸°
      function closeSidebar() {
        mobileSidebar.classList.remove('active');
        mobileSidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      // í–„ë²„ê±° ë©”ë‰´ í´ë¦­
      mobileMenuBtn.addEventListener('click', openSidebar);

      // ì‚¬ì´ë“œë°” ë‹«ê¸° ë²„íŠ¼ í´ë¦­
      sidebarClose.addEventListener('click', closeSidebar);

      // ì‚¬ì´ë“œë°” ë§í¬ í´ë¦­ ì‹œ ë‹«ê¸°
      sidebarLinks.forEach(link => {
        link.addEventListener('click', closeSidebar);
      });

      // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
      mobileSidebarOverlay.addEventListener('click', closeSidebar);
    }

    // í—¤ë” ì´ë²¤íŠ¸ ì´ˆê¸°í™”
    initHeaderEvents();
    
    // í˜ì´ì§€ ì´ˆê¸°í™”
    initializePage();

  </script>
</body>
</html>
