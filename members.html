<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>길드원 정리 & 업로드</title>
  <meta name="color-scheme" content="dark light">
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="./js/data-manager.js"></script>
</head>
<body>
  <!-- 상단 헤더 -->
  <header class="main-header">
    <div class="header-content">
      <a href="./index.html" class="logo">
        <h1>🏰 NBTI 길드</h1>
      </a>
      <nav class="header-nav">
        <a href="./picture.html" class="nav-link" data-page="picture">
          <img src="./img/camera.png" alt="카메라" class="nav-icon">
          사진첩
        </a>
        <a href="./members.html" class="nav-link" data-page="members">👥 길드원</a>
        <a href="#" class="nav-link login-btn" id="loginBtn" title="로그인">
          <i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i>
        </a>
      </nav>
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- 모바일 사이드바 오버레이 -->
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

  <!-- 모바일 사이드바 -->
  <div class="mobile-sidebar" id="mobileSidebar">
    <div class="sidebar-header">
      <a href="./index.html" class="sidebar-logo">
        <h2>🏰 NBTI 길드</h2>
      </a>
      <button class="sidebar-close" id="sidebarClose">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="./picture.html" class="sidebar-link" data-page="picture">
        <img src="./img/camera.png" alt="카메라" class="sidebar-icon">
        사진첩
      </a>
      <a href="./members.html" class="sidebar-link" data-page="members">👥 길드원</a>
      <a href="#" class="sidebar-link login-btn" id="mobileLoginBtn" title="로그인">
        <i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i> 로그인
      </a>
    </nav>
  </div>

  <!-- 히어로 섹션 -->
  <section class="hero-section">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <p class="hero-subtitle">마비노기 모바일 던컨 서버</p>
      <h1 class="hero-title">NBTI 길드</h1>
    </div>
  </section>

  <div class="wrap">
    <div class="page-header">
      <div class="page-title-row">
        <h1>👥 길드원 정리</h1>
        <button class="search-toggle-btn" id="searchToggle" title="검색">
          🔍
        </button>
      </div>
      <nav class="toolbar">
        <button class="btn" id="addMember" style="display:none">길드원 추가</button>
      </nav>
      <div class="search search-collapsed" id="searchContainer">
        <input id="q" placeholder="검색: 이름/직책">
      </div>
    </div>

    <section id="grid" class="grid"></section>
  </div>


  <template id="cardTmpl">
    <article class="card">
      <div class="cover">
        <span class="cover-placeholder" style="opacity:.5">커버 없음</span>
        <div class="cover-upload-icon" style="display:none">
          <input type="file" class="cover-file-input" accept="image/*" style="display:none">
          <button class="cover-upload-btn" title="커버 이미지 업로드">📷</button>
        </div>
      </div>
      <div class="meta">
        <h3 class="title"></h3>
        <p class="sub"></p>
        <div class="row" style="gap:6px;margin-top:10px;flex-wrap:wrap">
          <a class="pill link" target="_blank" style="display:none">원본</a>
        </div>
      </div>
    </article>
  </template>

  <!-- 로그인 모달 -->
  <div id="loginModal" class="login-modal">
    <div class="login-modal-content">
      <div class="login-modal-header">
        <h2>길드원 로그인</h2>
        <button class="login-modal-close" id="loginModalClose">&times;</button>
      </div>
      <div class="login-modal-body">
        <form id="loginForm">
          <div class="form-group">
            <label for="loginId">아이디</label>
            <input type="text" id="loginId" placeholder="아이디를 입력하세요" required>
          </div>
          <div class="form-group">
            <label for="password">비밀번호</label>
            <input type="password" id="password" placeholder="비밀번호를 입력하세요" required>
          </div>
          <button type="submit" class="btn btn-primary">로그인</button>
        </form>
        <div class="login-help">
          <p>💡 테스트 계정:</p>
          <ul>
            <li>작은음표: smallnote / guildmaster123</li>
            <li>아쉬운데잉: ashy / ashy123</li>
            <li>돌하나: dol / dol123</li>
            <li>전사도로롱: doro / doro123</li>
            <li>이시후: sihu / sihu123</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const IMGBB_KEY = "ee1e38cf23a8ac3daf5a2dca469763ab";

    // 데이터 관리

    const grid = document.getElementById('grid');
    const cardTmpl = document.getElementById('cardTmpl');
    const q = document.getElementById('q');
    const addMember = document.getElementById('addMember');
    
    // 검색 토글 관련 요소들
    const searchToggle = document.getElementById('searchToggle');
    const searchContainer = document.getElementById('searchContainer');
    
    // 관리자 권한 확인
    const ADMIN_KEY = "admin.authenticated";
    const isAdmin = localStorage.getItem(ADMIN_KEY) === 'true';

    async function loadMembers(){
      try{
        return await dataManager.loadMembers();
      }catch(e){ 
        console.error('길드원 로드 실패:', e);
        return []; 
      }
    }
    
    function fmtDate(ts){ 
      return utils.formatDate(ts); 
    }
    
    function escapeHtml(s){ 
      return utils.escapeHtml(s); 
    }

    async function render(filter=""){
      // 캐시를 강제로 새로고침하여 최신 데이터 보장
      dataManager.clearCache();
      const members = await loadMembers();
      const term = filter.trim().toLowerCase();
      const filtered = term ? members.filter(m=>{
        return [m.name,m.role].join(" ").toLowerCase().includes(term);
      }) : members;

      grid.innerHTML = "";
      for(const m of filtered){
        const node = cardTmpl.content.cloneNode(true);
        const card = node.querySelector('.card');
        const cover = node.querySelector('.cover');
        const coverPlaceholder = node.querySelector('.cover-placeholder');
        const ttl = node.querySelector('.title');
        const sub = node.querySelector('.sub');
        const link = node.querySelector('.link');
        const coverUploadIcon = node.querySelector('.cover-upload-icon');
        const coverFileInput = node.querySelector('.cover-file-input');
        const coverUploadBtn = node.querySelector('.cover-upload-btn');

        ttl.textContent = m.name;
        sub.textContent = m.role || "길드원";
        
        // 개별 멤버의 커버 이미지 사용 (없으면 기본 이미지)
        if (m.cover) {
          // 커버 이미지가 있는 경우
          cover.style.backgroundImage = `url('${m.cover}')`;
          coverPlaceholder.style.display = 'none'; // "커버 없음" 텍스트 숨김
        } else {
          // 커버 이미지가 없는 경우 기본 이미지 사용
          cover.style.backgroundImage = `url('img/cover.webp')`;
          coverPlaceholder.style.display = 'block'; // "커버 없음" 텍스트 표시
        }
        
        // 관리자 권한에 따른 커버 업로드 아이콘 표시
        if (isAdmin) {
          coverUploadIcon.style.display = 'block';
        }

        // 커버 업로드 동작
        coverUploadBtn.onclick = () => {
          coverFileInput.click();
        };

        coverFileInput.onchange = async (e) => {
          const f = e.target.files?.[0];
          if(!f){ return; }
          
          coverUploadBtn.disabled = true; 
          coverUploadBtn.textContent = "업로드 중…";
          
          try{
            const fd = new FormData(); 
            fd.append("image", f);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {method:"POST",body:fd});
            if(!res.ok) throw new Error("ImgBB 업로드 실패");
            const data = await res.json();
            const url = data?.data?.url || data?.data?.display_url;
            if(!url) throw new Error("응답 파싱 실패");

            // 길드원 커버 업데이트
            const success = await dataManager.updateMember(m.id, { cover: url });
            if (success) {
              m.cover = url;
              // 커버 이미지 업데이트
              cover.style.backgroundImage = `url('${url}')`;
              coverPlaceholder.style.display = 'none'; // "커버 없음" 텍스트 숨김
              coverUploadIcon.style.display = 'none';
              
              // 사진첩에도 동일 아이템으로 추가
              const photoData = {
                url,
                title: `${m.name} 커버 이미지`,
                subtitle: "길드원 커버",
                author: m.name,
                tags: ["길드", "커버"]
              };
              await dataManager.addPhoto(photoData);
              
              // 카드의 최근 링크 표기
              link.href = url; 
              link.style.display="inline-block"; 
              link.textContent = "원본";

              alert("커버 이미지가 업로드되었습니다!");
            } else {
              alert("커버 업데이트에 실패했습니다.");
            }
          }catch(err){
            alert(err.message);
          }finally{
            coverUploadBtn.disabled=false; 
            coverUploadBtn.textContent="📷";
            coverFileInput.value = '';
          }
        };


        grid.appendChild(node);
      }
    }

    // 검색 토글 기능
    function toggleSearch() {
      searchContainer.classList.toggle('search-collapsed');
      if (searchContainer.classList.contains('search-collapsed')) {
        searchToggle.textContent = '🔍';
        searchToggle.title = '검색';
        searchToggle.classList.remove('close-btn');
        q.value = '';
        render('');
      } else {
        searchToggle.textContent = '';
        searchToggle.title = '검색 닫기';
        searchToggle.classList.add('close-btn');
        q.focus();
      }
    }

    // 검색 토글 버튼 이벤트
    searchToggle.addEventListener('click', toggleSearch);

    // 관리자 권한에 따른 UI 표시
    if (isAdmin) {
      addMember.style.display = 'inline-block';
    }

    // 검색
    q.addEventListener('input', async ()=>await render(q.value));

    // 길드원 추가 (관리자만)
    addMember.onclick = async ()=>{
      if (!isAdmin) return;
      const name = prompt("길드원 이름"); if(!name) return;
      const role = prompt("직책/상태(예: 길드원, 밤샘, 새벽, 저녁 등)") || "길드원";
      
      try {
        const memberData = {
          name,
          role,
          cover: "",
          avatar: name.charAt(0),
          description: `${role}`
        };
        
        await dataManager.addMember(memberData);
        await render(q.value);
      } catch (error) {
        console.error('길드원 추가 오류:', error);
        alert('길드원 추가에 실패했습니다.');
      }
    };


    // 헤더 이벤트 초기화 함수
    function initHeaderEvents() {
      // 현재 페이지 감지 및 활성 상태 설정
      const currentPage = getCurrentPage();
      setActiveNav(currentPage);
      
      // 모바일 메뉴 기능
      initMobileMenu();
    }

    // 현재 페이지 감지
    function getCurrentPage() {
      const path = window.location.pathname;
      if (path.includes('index.html') || path === '/' || path.endsWith('/')) return 'index';
      if (path.includes('picture.html')) return 'picture';
      if (path.includes('members.html')) return 'members';
      if (path.includes('mypage.html')) return 'mypage';
      if (path.includes('admin.html')) return 'admin';
      return 'index';
    }

    // 활성 네비게이션 설정
    function setActiveNav(currentPage) {
      // 데스크톱 네비게이션
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });
      
      // 모바일 사이드바 네비게이션
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });
    }

    // 모바일 메뉴 기능
    function initMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileSidebar = document.getElementById('mobileSidebar');
      const mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarLinks = document.querySelectorAll('.sidebar-link');

      if (!mobileMenuBtn || !mobileSidebar || !mobileSidebarOverlay) return;

      // 사이드바 열기
      function openSidebar() {
        mobileSidebar.classList.add('active');
        mobileSidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      // 사이드바 닫기
      function closeSidebar() {
        mobileSidebar.classList.remove('active');
        mobileSidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      // 햄버거 메뉴 클릭
      mobileMenuBtn.addEventListener('click', openSidebar);

      // 사이드바 닫기 버튼 클릭
      sidebarClose.addEventListener('click', closeSidebar);

      // 사이드바 링크 클릭 시 닫기
      sidebarLinks.forEach(link => {
        link.addEventListener('click', closeSidebar);
      });

      // 오버레이 클릭 시 닫기
      mobileSidebarOverlay.addEventListener('click', closeSidebar);
    }

    // 로그인 모달 관련 변수
    let currentUser = null;
    const loginModal = document.getElementById('loginModal');
    const loginBtn = document.getElementById('loginBtn');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');
    const loginModalClose = document.getElementById('loginModalClose');
    const loginForm = document.getElementById('loginForm');

    // 로그인 모달 열기
    function openLoginModal() {
      loginModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // 로그인 모달 닫기
    function closeLoginModal() {
      loginModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    // 로그인 처리
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const loginId = document.getElementById('loginId').value;
      const password = document.getElementById('password').value;
      
      try {
        // 캐시를 강제로 새로고침하여 최신 데이터 보장
        dataManager.clearCache();
        const members = await dataManager.loadMembers();
        const user = members.find(member => 
          member.loginId === loginId && member.password === password
        );
        
        if (user) {
          currentUser = user;
          // 로그인 시간 업데이트
          await dataManager.updateMember(user.id, { lastLogin: Date.now() });
          
          // 세션 저장
          localStorage.setItem('user.authenticated', 'true');
          localStorage.setItem('user.id', user.id);
          
          // 로그인 버튼을 마이페이지 버튼으로 변경
          updateLoginButton();
          closeLoginModal();
          
          alert(`${user.name}님, 환영합니다!`);
        } else {
          alert('아이디 또는 비밀번호가 올바르지 않습니다.');
        }
      } catch (error) {
        console.error('로그인 오류:', error);
        alert('로그인 중 오류가 발생했습니다.');
      }
    });

    // 로그인 버튼 업데이트
    function updateLoginButton() {
      if (currentUser) {
        loginBtn.innerHTML = `<i class="fa-solid fa-user" style="color: #4CAF50;"></i>`;
        loginBtn.title = `${currentUser.name}님 (클릭하여 마이페이지)`;
        loginBtn.href = './mypage.html';
        
        mobileLoginBtn.innerHTML = `<i class="fa-solid fa-user" style="color: #4CAF50;"></i> ${currentUser.name}`;
        mobileLoginBtn.title = '마이페이지';
        mobileLoginBtn.href = './mypage.html';
      } else {
        loginBtn.innerHTML = `<i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i>`;
        loginBtn.title = '로그인';
        loginBtn.href = '#';
        
        mobileLoginBtn.innerHTML = `<i class="fa-solid fa-right-to-bracket" style="color: #FFD43B;"></i> 로그인`;
        mobileLoginBtn.title = '로그인';
        mobileLoginBtn.href = '#';
      }
    }

    // 로그인 버튼 클릭 이벤트
    loginBtn.addEventListener('click', (e) => {
      if (!currentUser) {
        e.preventDefault();
        openLoginModal();
      }
    });

    mobileLoginBtn.addEventListener('click', (e) => {
      if (!currentUser) {
        e.preventDefault();
        openLoginModal();
      }
    });

    // 모달 닫기 이벤트
    loginModalClose.addEventListener('click', closeLoginModal);
    loginModal.addEventListener('click', (e) => {
      if (e.target === loginModal) {
        closeLoginModal();
      }
    });

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && loginModal.style.display === 'flex') {
        closeLoginModal();
      }
    });

    // 세션 확인 및 로그인 상태 복원
    function checkLoginStatus() {
      const isAuthenticated = localStorage.getItem('user.authenticated') === 'true';
      const userId = localStorage.getItem('user.id');
      
      if (isAuthenticated && userId) {
        // 캐시를 강제로 새로고침하여 최신 데이터 보장
        dataManager.clearCache();
        dataManager.loadMembers().then(members => {
          const user = members.find(member => member.id === userId);
          if (user) {
            currentUser = user;
            updateLoginButton();
          }
        }).catch(error => {
          console.error('사용자 정보 로드 오류:', error);
        });
      }
    }

    // 페이지 초기화
    async function initializePage() {
      try {
        await render();
        checkLoginStatus();
        console.log('길드원 페이지가 로드되었습니다.');
      } catch (error) {
        console.error('페이지 초기화 중 오류:', error);
      }
    }
    
    // 헤더 이벤트 초기화
    initHeaderEvents();
    
    // 페이지 초기화
    initializePage();
  </script>
</body>
</html>
