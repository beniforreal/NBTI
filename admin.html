<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <meta name="color-scheme" content="dark light">
  <link rel="stylesheet" href="./styles.css">
  <script src="./js/data-manager.js"></script>
</head>
<body>
  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="main-header">
    <div class="header-content">
      <a href="./index.html" class="logo">
        <h1>ğŸ° NBTI ê¸¸ë“œ</h1>
      </a>
      <nav class="header-nav">
        <a href="./picture.html" class="nav-link" data-page="picture">
          <img src="./img/camera.png" alt="ì¹´ë©”ë¼" class="nav-icon">
          ì‚¬ì§„ì²©
        </a>
        <a href="./members.html" class="nav-link" data-page="members">ğŸ‘¥ ê¸¸ë“œì›</a>
        <a href="./admin.html" class="nav-link" data-page="admin">ğŸ” ê´€ë¦¬ì</a>
        <button class="header-logout" id="headerLogout">ë¡œê·¸ì•„ì›ƒ</button>
      </nav>
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

  <!-- ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” -->
  <div class="mobile-sidebar" id="mobileSidebar">
    <div class="sidebar-header">
      <a href="./index.html" class="sidebar-logo">
        <h2>ğŸ° NBTI ê¸¸ë“œ</h2>
      </a>
      <button class="sidebar-close" id="sidebarClose">&times;</button>
    </div>
    <nav class="sidebar-nav">
      <a href="./picture.html" class="sidebar-link" data-page="picture">
        <img src="./img/camera.png" alt="ì¹´ë©”ë¼" class="sidebar-icon">
        ì‚¬ì§„ì²©
      </a>
      <a href="./members.html" class="sidebar-link" data-page="members">ğŸ‘¥ ê¸¸ë“œì›</a>
      <a href="./admin.html" class="sidebar-link" data-page="admin">ğŸ” ê´€ë¦¬ì</a>
    </nav>
  </div>

  <div class="admin-wrap">
    <div id="loginSection" class="login-card">
      <h1 class="login-title">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
      <p class="login-subtitle">NBTI ê¸¸ë“œ ì‚¬ì§„ì²© ê´€ë¦¬ì í˜ì´ì§€</p>
      
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="password">ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="password" class="form-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>
        <button type="submit" class="admin-btn">ë¡œê·¸ì¸</button>
        <div id="errorMsg" class="error" style="display:none"></div>
      </form>
    </div>

    <div id="adminSection" class="login-card" style="display:none">
      <button id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
      <h1 class="login-title">ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      <p class="login-subtitle">ì‚¬ì§„ì²© ê´€ë¦¬ ë„êµ¬</p>
      
      <div class="admin-links">
        <a href="./index.html" class="admin-link">
          <h3>ğŸ“· ì‚¬ì§„ì²© ê´€ë¦¬</h3>
          <p>ì‚¬ì§„ ì—…ë¡œë“œ, ìˆ˜ì •, ì‚­ì œ</p>
        </a>
        <a href="./members.html" class="admin-link">
          <h3>ğŸ‘¥ ê¸¸ë“œì› ê´€ë¦¬</h3>
          <p>ê¸¸ë“œì› ì¶”ê°€, ì‚­ì œ, ì—…ë¡œë“œ</p>
        </a>
      </div>
      
      <div class="admin-members-section">
        <h3>ğŸ‘¥ ê¸¸ë“œì› ê´€ë¦¬</h3>
        <div class="members-list" id="membersList">
          <!-- ê¸¸ë“œì› ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
      </div>
      
      <div class="admin-status">
        <h3>ğŸ“Š í˜„ì¬ ìƒíƒœ</h3>
        <div class="admin-stats">
          <div>ì‚¬ì§„ ê°œìˆ˜: <span id="photoCount">0</span></div>
          <div>ê¸¸ë“œì› ìˆ˜: <span id="memberCount">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
  <div id="deleteModal" class="delete-modal">
    <div class="delete-content">
      <div class="delete-header">
        <h2 class="delete-title">âš ï¸ ì‚­ì œ í™•ì¸</h2>
      </div>
      <div class="delete-body">
        <p id="deleteMessage" class="delete-message">ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div class="delete-actions">
          <button id="deleteCancel" class="admin-btn btn-cancel">ì·¨ì†Œ</button>
          <button id="deleteConfirm" class="admin-btn btn-danger">ì‚­ì œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ê¸¸ë“œì› ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editMemberModal" class="edit-modal">
    <div class="edit-content">
      <div class="edit-header">
        <h2 class="edit-title">âœï¸ ê¸¸ë“œì› ì •ë³´ ìˆ˜ì •</h2>
        <button id="editClose" class="edit-close">&times;</button>
      </div>
      <div class="edit-body">
        <form id="editMemberForm">
          <div class="form-group">
            <label class="form-label" for="editName">ë‹‰ë„¤ì„</label>
            <input type="text" id="editName" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="editRole">ì§ì±…</label>
            <input type="text" id="editRole" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="editDescription">ì„¤ëª…</label>
            <textarea id="editDescription" class="form-input" rows="3"></textarea>
          </div>
          <div class="edit-actions">
            <button type="button" id="editCancel" class="admin-btn btn-cancel">ì·¨ì†Œ</button>
            <button type="submit" class="admin-btn">ìˆ˜ì •</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ë³´ì•ˆ ê°•í™”ëœ ê´€ë¦¬ì ì¸ì¦ ì‹œìŠ¤í…œ
    const ADMIN_KEY = "admin.authenticated";
    const ADMIN_SESSION_KEY = "admin.session";
    const SESSION_TIMEOUT = 2 * 60 * 60 * 1000; // 2ì‹œê°„
    const IP_LOCK_KEY = "admin.ip_locks";
    const MAX_ATTEMPTS = 3;
    const LOCK_DURATION = 24 * 60 * 60 * 1000; // 24ì‹œê°„
    
    // í•´ì‹œ í•¨ìˆ˜ (ê°„ë‹¨í•œ í•´ì‹œ)
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // 32bit ì •ìˆ˜ë¡œ ë³€í™˜
      }
      return Math.abs(hash).toString(16);
    }
    
    // ë¹„ë°€ë²ˆí˜¸ í•´ì‹œê°’ (ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸: nbti2024)
    const ADMIN_PASSWORD_HASH = "514ac857"; // simpleHash("nbti2024")ì˜ ê²°ê³¼ê°’
    
    // í´ë¼ì´ì–¸íŠ¸ IP ì¶”ì¶œ (ê°„ë‹¨í•œ ë°©ë²•)
    function getClientIP() {
      // ì‹¤ì œ IPëŠ” ì„œë²„ì—ì„œë§Œ ì–»ì„ ìˆ˜ ìˆì§€ë§Œ, í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œëŠ” 
      // User-Agent + ì‹œê°„ëŒ€ + í™”ë©´ í•´ìƒë„ ë“±ì„ ì¡°í•©í•˜ì—¬ ê³ ìœ  ì‹ë³„ì ìƒì„±
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('IP fingerprint', 2, 2);
      
      const fingerprint = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        canvas.toDataURL()
      ].join('|');
      
      return simpleHash(fingerprint);
    }
    
    // IP ë½ ê´€ë¦¬
    function getIPLocks() {
      try {
        return JSON.parse(localStorage.getItem(IP_LOCK_KEY) || '{}');
      } catch (e) {
        return {};
      }
    }
    
    function saveIPLocks(locks) {
      localStorage.setItem(IP_LOCK_KEY, JSON.stringify(locks));
    }
    
    function isIPLocked() {
      const clientIP = getClientIP();
      const locks = getIPLocks();
      const lockData = locks[clientIP];
      
      if (!lockData) return false;
      
      const now = Date.now();
      if (now - lockData.timestamp > LOCK_DURATION) {
        // ë½ ë§Œë£Œ
        delete locks[clientIP];
        saveIPLocks(locks);
        return false;
      }
      
      return true;
    }
    
    function addIPAttempt() {
      const clientIP = getClientIP();
      const locks = getIPLocks();
      
      if (!locks[clientIP]) {
        locks[clientIP] = { attempts: 0, timestamp: Date.now() };
      }
      
      locks[clientIP].attempts++;
      locks[clientIP].timestamp = Date.now();
      
      if (locks[clientIP].attempts >= MAX_ATTEMPTS) {
        locks[clientIP].locked = true;
        locks[clientIP].lockTime = Date.now();
      }
      
      saveIPLocks(locks);
      return locks[clientIP].attempts;
    }
    
    function clearIPAttempts() {
      const clientIP = getClientIP();
      const locks = getIPLocks();
      delete locks[clientIP];
      saveIPLocks(locks);
    }
    
    const loginSection = document.getElementById('loginSection');
    const adminSection = document.getElementById('adminSection');
    const loginForm = document.getElementById('loginForm');
    const passwordInput = document.getElementById('password');
    const errorMsg = document.getElementById('errorMsg');
    const logoutBtn = document.getElementById('logoutBtn');
    const headerLogout = document.getElementById('headerLogout');
    const photoCount = document.getElementById('photoCount');
    const memberCount = document.getElementById('memberCount');
    const membersList = document.getElementById('membersList');
    
    // ì‚­ì œ ëª¨ë‹¬ ìš”ì†Œë“¤
    const deleteModal = document.getElementById('deleteModal');
    const deleteMessage = document.getElementById('deleteMessage');
    const deleteCancel = document.getElementById('deleteCancel');
    const deleteConfirm = document.getElementById('deleteConfirm');
    
    // ìˆ˜ì • ëª¨ë‹¬ ìš”ì†Œë“¤
    const editMemberModal = document.getElementById('editMemberModal');
    const editMemberForm = document.getElementById('editMemberForm');
    const editName = document.getElementById('editName');
    const editRole = document.getElementById('editRole');
    const editDescription = document.getElementById('editDescription');
    const editClose = document.getElementById('editClose');
    const editCancel = document.getElementById('editCancel');
    
    let currentEditingMember = null;

    // ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬
    function isSessionValid() {
      const sessionData = localStorage.getItem(ADMIN_SESSION_KEY);
      if (!sessionData) return false;
      
      try {
        const session = JSON.parse(sessionData);
        const now = Date.now();
        return (now - session.timestamp) < SESSION_TIMEOUT;
      } catch (e) {
        return false;
      }
    }
    
    // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
    async function checkAdminAuth() {
      console.log('checkAdminAuth í˜¸ì¶œë¨');
      // IP ë½ í™•ì¸
      if (isIPLocked()) {
        console.log('IPê°€ ë½ë¨');
        showLockedMessage();
        return;
      }
      
      const isAuthenticated = localStorage.getItem(ADMIN_KEY) === 'true';
      const sessionValid = isSessionValid();
      
      console.log('ì¸ì¦ ìƒíƒœ:', isAuthenticated, 'ì„¸ì…˜ ìœ íš¨:', sessionValid);
      
      if (isAuthenticated && sessionValid) {
        console.log('ê´€ë¦¬ì ì¸ì¦ë¨, ê´€ë¦¬ì ì„¹ì…˜ í‘œì‹œ');
        await showAdminSection();
      } else {
        // ì„¸ì…˜ ë§Œë£Œ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ
        if (isAuthenticated && !sessionValid) {
          console.log('ì„¸ì…˜ ë§Œë£Œ, ë¡œê·¸ì•„ì›ƒ');
          logout();
        }
        console.log('ë¡œê·¸ì¸ ì„¹ì…˜ í‘œì‹œ');
        showLoginSection();
      }
    }

    // ë½ ë©”ì‹œì§€ í‘œì‹œ
    function showLockedMessage() {
      loginSection.innerHTML = `
        <h1 class="login-title">ğŸš« ì ‘ê·¼ ì°¨ë‹¨</h1>
        <p class="login-subtitle">ë„ˆë¬´ ë§ì€ ë¡œê·¸ì¸ ì‹œë„ë¡œ ì¸í•´ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <div style="margin:20px 0;padding:20px;background:#2a1010;border:1px solid #5a1c1c;border-radius:10px">
          <p style="color:var(--danger);margin:0;font-size:14px">
            ì´ ê¸°ê¸°ì—ì„œ 3ë²ˆì˜ ë¡œê·¸ì¸ ì‹¤íŒ¨ë¡œ ì¸í•´ 24ì‹œê°„ ë™ì•ˆ ì ‘ê·¼ì´ ì œí•œë©ë‹ˆë‹¤.<br>
            ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ 24ì‹œê°„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
          </p>
        </div>
        <div style="margin-top:20px;font-size:12px;color:var(--muted)">
          <p>ì°¨ë‹¨ëœ ê¸°ê¸° ì •ë³´:</p>
          <p style="font-family:monospace;word-break:break-all">${getClientIP()}</p>
        </div>
      `;
      adminSection.style.display = 'none';
    }

    // ë¡œê·¸ì¸ ì„¹ì…˜ í‘œì‹œ
    function showLoginSection() {
      // ê¸°ì¡´ ë¡œê·¸ì¸ ì„¹ì…˜ì„ ë‹¤ì‹œ í‘œì‹œ
      loginSection.style.display = 'block';
      adminSection.style.display = 'none';
      headerLogout.classList.remove('show');
      
      // ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
      const errorMsg = document.getElementById('errorMsg');
      if (errorMsg) {
        errorMsg.style.display = 'none';
      }
      
      // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      const passwordInput = document.getElementById('password');
      if (passwordInput) {
        passwordInput.value = '';
      }
    }

    // ê´€ë¦¬ì ì„¹ì…˜ í‘œì‹œ
    async function showAdminSection() {
      console.log('showAdminSection í˜¸ì¶œë¨');
      loginSection.style.display = 'none';
      adminSection.style.display = 'block';
      headerLogout.classList.add('show');
      console.log('í—¤ë” ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë˜ìŠ¤:', headerLogout.className);
      await updateStats();
      await loadMembersList();
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    async function updateStats() {
      try {
        // ìºì‹œë¥¼ ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ë°ì´í„° ë³´ì¥
        dataManager.clearCache();
        const stats = await dataManager.getStats();
        photoCount.textContent = stats.photoCount;
        memberCount.textContent = stats.memberCount;
      } catch (e) {
        console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
        photoCount.textContent = '0';
        memberCount.textContent = '0';
      }
    }

    // ê¸¸ë“œì› ëª©ë¡ ë¡œë“œ
    async function loadMembersList() {
      try {
        // ìºì‹œë¥¼ ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ë°ì´í„° ë³´ì¥
        dataManager.clearCache();
        const members = await dataManager.loadMembers();
        membersList.innerHTML = '';
        
        if (members.length === 0) {
          membersList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">ë“±ë¡ëœ ê¸¸ë“œì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        members.forEach(member => {
          const memberItem = document.createElement('div');
          memberItem.className = 'member-item';
          memberItem.innerHTML = `
            <div class="member-info">
              <div class="member-avatar-small">${member.avatar || member.name.charAt(0)}</div>
              <div class="member-details">
                <h4 class="member-name">${utils.escapeHtml(member.name)}</h4>
                <p class="member-role">${utils.escapeHtml(member.role)}</p>
                <p class="member-description">${utils.escapeHtml(member.description || '')}</p>
              </div>
            </div>
            <div class="member-actions">
              <button class="btn-edit" data-id="${member.id}">ìˆ˜ì •</button>
              <button class="btn-delete" data-id="${member.id}">ì‚­ì œ</button>
            </div>
          `;
          membersList.appendChild(memberItem);
        });
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        membersList.querySelectorAll('.btn-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const memberId = e.target.getAttribute('data-id');
            const member = members.find(m => m.id === memberId);
            if (member) {
              openEditModal(member);
            }
          });
        });
        
        membersList.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const memberId = e.target.getAttribute('data-id');
            const member = members.find(m => m.id === memberId);
            if (member) {
              showDeleteModal(
                `ì •ë§ë¡œ '${member.name}' ê¸¸ë“œì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
                async () => {
                  const success = await dataManager.deleteMember(memberId);
                  if (success) {
                    await loadMembersList();
                    await updateStats();
                  } else {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  }
                }
              );
            }
          });
        });
        
      } catch (error) {
        console.error('ê¸¸ë“œì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        membersList.innerHTML = '<p style="text-align: center; color: var(--danger); padding: 20px;">ê¸¸ë“œì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function openEditModal(member) {
      currentEditingMember = member;
      editName.value = member.name;
      editRole.value = member.role;
      editDescription.value = member.description || '';
      editMemberModal.style.display = 'flex';
    }

    // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeEditModal() {
      editMemberModal.style.display = 'none';
      currentEditingMember = null;
      editMemberForm.reset();
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
    async function handleLogin(e) {
      e.preventDefault();
      const passwordInput = document.getElementById('password');
      const errorMsg = document.getElementById('errorMsg');
      const password = passwordInput.value.trim();
      const passwordHash = simpleHash(password);
      
      if (passwordHash === ADMIN_PASSWORD_HASH) {
        // ì¸ì¦ ì„±ê³µ
        console.log('ë¡œê·¸ì¸ ì„±ê³µ!');
        localStorage.setItem(ADMIN_KEY, 'true');
        clearIPAttempts(); // ì„±ê³µ ì‹œ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
        
        // ì„¸ì…˜ ì •ë³´ ì €ì¥
        const sessionData = {
          timestamp: Date.now(),
          userAgent: navigator.userAgent,
          ip: getClientIP()
        };
        localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify(sessionData));
        
        await showAdminSection();
      } else {
        // ì‹¤íŒ¨ ì‹œ IP ê¸°ë°˜ ë½ ì²˜ë¦¬
        const attempts = addIPAttempt();
        const remainingAttempts = MAX_ATTEMPTS - attempts;
        
        if (attempts >= MAX_ATTEMPTS) {
          showLockedMessage();
        } else {
          errorMsg.textContent = `ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (${remainingAttempts}íšŒ ë‚¨ìŒ)`;
          errorMsg.style.display = 'block';
          passwordInput.value = '';
        }
      }
    }

    // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
    function logout() {
      localStorage.removeItem(ADMIN_KEY);
      localStorage.removeItem(ADMIN_SESSION_KEY);
      localStorage.removeItem('login_attempts');
    }
    
    // ê´€ë¦¬ììš© ë½ í•´ì œ í•¨ìˆ˜ (ê°œë°œì ë„êµ¬ì—ì„œ ì‚¬ìš©)
    function unlockAllIPs() {
      localStorage.removeItem(IP_LOCK_KEY);
      console.log('ëª¨ë“  IP ë½ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // íŠ¹ì • IP ë½ í•´ì œ í•¨ìˆ˜
    function unlockIP(ipHash) {
      const locks = getIPLocks();
      delete locks[ipHash];
      saveIPLocks(locks);
      console.log(`IP ${ipHash}ì˜ ë½ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
    
    // í˜„ì¬ ë½ëœ IP ëª©ë¡ í™•ì¸
    function getLockedIPs() {
      const locks = getIPLocks();
      const lockedIPs = [];
      for (const [ip, data] of Object.entries(locks)) {
        if (data.locked) {
          lockedIPs.push({
            ip: ip,
            attempts: data.attempts,
            lockTime: new Date(data.lockTime).toLocaleString(),
            remainingTime: Math.max(0, LOCK_DURATION - (Date.now() - data.lockTime))
          });
        }
      }
      console.table(lockedIPs);
      return lockedIPs;
    }
    
    // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ í•¨ìˆ˜ë“¤
    let currentDeleteCallback = null;
    
    function showDeleteModal(message, callback) {
      deleteMessage.textContent = message;
      currentDeleteCallback = callback;
      deleteModal.style.display = 'flex';
    }
    
    function hideDeleteModal() {
      deleteModal.style.display = 'none';
      currentDeleteCallback = null;
    }
    
    // ì‚­ì œ ëª¨ë‹¬ ì´ë²¤íŠ¸
    deleteCancel.addEventListener('click', hideDeleteModal);
    deleteConfirm.addEventListener('click', () => {
      if (currentDeleteCallback) {
        currentDeleteCallback();
      }
      hideDeleteModal();
    });
    
    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        hideDeleteModal();
      }
    });
    
    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && deleteModal.style.display === 'flex') {
        hideDeleteModal();
      }
      if (e.key === 'Escape' && editMemberModal.style.display === 'flex') {
        closeEditModal();
      }
    });

    // ìˆ˜ì • í¼ ì œì¶œ
    editMemberForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentEditingMember) return;
      
      try {
        const updateData = {
          name: editName.value.trim(),
          role: editRole.value.trim(),
          description: editDescription.value.trim(),
          avatar: editName.value.trim().charAt(0)
        };
        
        const success = await dataManager.updateMember(currentEditingMember.id, updateData);
        if (success) {
          closeEditModal();
          await loadMembersList();
          await updateStats();
          // ìˆ˜ì • ì„±ê³µ ë©”ì‹œì§€ëŠ” dataManagerì—ì„œ ì²˜ë¦¬ë¨
        } else {
          alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ê¸¸ë“œì› ìˆ˜ì • ì˜¤ë¥˜:', error);
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ìˆ˜ì • ëª¨ë‹¬ ì´ë²¤íŠ¸
    editClose.addEventListener('click', closeEditModal);
    editCancel.addEventListener('click', closeEditModal);
    editMemberModal.addEventListener('click', (e) => {
      if (e.target === editMemberModal) {
        closeEditModal();
      }
    });
    
    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ê°œë°œì ë„êµ¬ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
    window.unlockAllIPs = unlockAllIPs;
    window.unlockIP = unlockIP;
    window.getLockedIPs = getLockedIPs;
    window.showDeleteModal = showDeleteModal;
    
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    logoutBtn.addEventListener('click', () => {
      logout();
      showLoginSection();
    });

    // í—¤ë” ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    headerLogout.addEventListener('click', () => {
      logout();
      showLoginSection();
    });

    // í—¤ë” ì´ë²¤íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
    function initHeaderEvents() {
      // í˜„ì¬ í˜ì´ì§€ ê°ì§€ ë° í™œì„± ìƒíƒœ ì„¤ì •
      const currentPage = getCurrentPage();
      setActiveNav(currentPage);
      
      // ëª¨ë°”ì¼ ë©”ë‰´ ê¸°ëŠ¥
      initMobileMenu();
    }

    // í˜„ì¬ í˜ì´ì§€ ê°ì§€
    function getCurrentPage() {
      const path = window.location.pathname;
      if (path.includes('index.html') || path === '/' || path.endsWith('/')) return 'index';
      if (path.includes('picture.html')) return 'picture';
      if (path.includes('members.html')) return 'members';
      if (path.includes('mypage.html')) return 'mypage';
      if (path.includes('admin.html')) return 'admin';
      return 'index';
    }

    // í™œì„± ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
    function setActiveNav(currentPage) {
      // ë°ìŠ¤í¬í†± ë„¤ë¹„ê²Œì´ì…˜
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });
      
      // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === currentPage) {
          link.classList.add('active');
        }
      });
    }

    // ëª¨ë°”ì¼ ë©”ë‰´ ê¸°ëŠ¥
    function initMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileSidebar = document.getElementById('mobileSidebar');
      const mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarLinks = document.querySelectorAll('.sidebar-link');

      if (!mobileMenuBtn || !mobileSidebar || !mobileSidebarOverlay) return;

      // ì‚¬ì´ë“œë°” ì—´ê¸°
      function openSidebar() {
        mobileSidebar.classList.add('active');
        mobileSidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      // ì‚¬ì´ë“œë°” ë‹«ê¸°
      function closeSidebar() {
        mobileSidebar.classList.remove('active');
        mobileSidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      // í–„ë²„ê±° ë©”ë‰´ í´ë¦­
      mobileMenuBtn.addEventListener('click', openSidebar);

      // ì‚¬ì´ë“œë°” ë‹«ê¸° ë²„íŠ¼ í´ë¦­
      sidebarClose.addEventListener('click', closeSidebar);

      // ì‚¬ì´ë“œë°” ë§í¬ í´ë¦­ ì‹œ ë‹«ê¸°
      sidebarLinks.forEach(link => {
        link.addEventListener('click', closeSidebar);
      });

      // ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
      mobileSidebarOverlay.addEventListener('click', closeSidebar);
    }

    // ì´ˆê¸° ë¡œê·¸ì¸ í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    const initialLoginForm = document.getElementById('loginForm');
    if (initialLoginForm) {
      initialLoginForm.addEventListener('submit', handleLogin);
    }

    // ì´ˆê¸° ë¡œë“œ
    initHeaderEvents();
    checkAdminAuth();
    
    // ê°œë°œì ë„êµ¬ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„ì›€ë§
    console.log(`
ğŸ” NBTI ê´€ë¦¬ì ì‹œìŠ¤í…œ ë„ì›€ë§:

ğŸ“‹ ë½ ê´€ë¦¬ ëª…ë ¹ì–´:
- getLockedIPs() : í˜„ì¬ ë½ëœ IP ëª©ë¡ í™•ì¸
- unlockAllIPs() : ëª¨ë“  IP ë½ í•´ì œ
- unlockIP('IPí•´ì‹œ') : íŠ¹ì • IP ë½ í•´ì œ

ğŸ—‘ï¸ ì‚­ì œ ê´€ë¦¬ ëª…ë ¹ì–´:
- showDeleteModal('ë©”ì‹œì§€', callback) : ì‚­ì œ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ

ğŸ’¡ ì‚¬ìš© ì˜ˆì‹œ:
- getLockedIPs() // ë½ëœ IP ëª©ë¡ ë³´ê¸°
- unlockAllIPs() // ëª¨ë“  ë½ í•´ì œ
- unlockIP('abc123') // íŠ¹ì • IP ë½ í•´ì œ
- showDeleteModal('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => console.log('ì‚­ì œë¨'))

âš ï¸ ì£¼ì˜: ì´ ëª…ë ¹ì–´ë“¤ì€ ê´€ë¦¬ìë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
    `);
  </script>
</body>
</html>
